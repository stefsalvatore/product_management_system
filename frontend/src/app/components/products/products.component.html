<div class="products-container">
  <h1>Products Management</h1>

  <div *ngIf="error" class="alert alert-error">{{ error }}</div>
  <div *ngIf="success" class="alert alert-success">{{ success }}</div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="btn btn-primary" (click)="openAddModal()">Add Product</button>
      <button class="btn btn-success" (click)="openBulkModal()">Bulk Upload</button>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-secondary" (click)="onExport('csv')">Export CSV</button>
      <button class="btn btn-secondary" (click)="onExport('xlsx')">Export XLSX</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters card">
    <div class="filter-group">
      <input type="text" class="form-control" placeholder="Search by name..." [(ngModel)]="searchTerm" (keyup.enter)="onSearch()">
    </div>
    <div class="filter-group">
      <input type="text" class="form-control" placeholder="Filter by category..." [(ngModel)]="categoryFilter" (keyup.enter)="onSearch()">
    </div>
    <div class="filter-group">
      <button class="btn btn-primary" (click)="onSearch()">Search</button>
    </div>
  </div>

  <!-- Products Table -->
  <div class="card">
    <div *ngIf="loading" class="loading">Loading products...</div>

    <table class="table" *ngIf="!loading && products.length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th (click)="onSort('name')" style="cursor: pointer;">
            Name {{ sortBy === 'name' ? (order === 'ASC' ? '▲' : '▼') : '' }}
          </th>
          <th>Image</th>
          <th (click)="onSort('price')" style="cursor: pointer;">
            Price {{ sortBy === 'price' ? (order === 'ASC' ? '▲' : '▼') : '' }}
          </th>
          <th>Category</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of products">
          <td>{{ product.id }}</td>
          <td>{{ product.name }}</td>
          <td>
            <img *ngIf="product.image" [src]="'http://localhost:3000' + product.image" alt="{{ product.name }}" width="50" height="50" style="object-fit: cover; border-radius: 4px;">
            <span *ngIf="!product.image">No image</span>
          </td>
          <td>${{ product.price }}</td>
          <td>{{ product.category_name }}</td>
          <td>
            <button class="btn btn-primary" style="margin-right: 5px;" (click)="openEditModal(product)">Edit</button>
            <button class="btn btn-danger" (click)="onDeleteProduct(product.id)">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!loading && products.length === 0" class="text-center" style="padding: 40px;">
      <p>No products found.</p>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="!loading && products.length > 0">
      <button [disabled]="currentPage === 1" (click)="onPageChange(currentPage - 1)">Previous</button>
      <button *ngFor="let page of pageNumbers" [class.active]="page === currentPage" (click)="onPageChange(page)">
        {{ page }}
      </button>
      <button [disabled]="currentPage === totalPages" (click)="onPageChange(currentPage + 1)">Next</button>
      <span style="margin-left: 20px;">Total: {{ total }} products</span>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div class="modal" *ngIf="showAddModal">
  <div class="modal-content">
    <h2>Add Product</h2>
    <form (ngSubmit)="onAddProduct()">
      <div class="form-group">
        <label>Product Name</label>
        <input type="text" class="form-control" [(ngModel)]="productForm.name" name="name" required>
      </div>
      <div class="form-group">
        <label>Price</label>
        <input type="number" step="0.01" class="form-control" [(ngModel)]="productForm.price" name="price" required>
      </div>
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" [(ngModel)]="productForm.category_id" name="category_id" required>
          <option value="">Select Category</option>
          <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Image</label>
        <input type="file" class="form-control" (change)="onFileSelected($event)" accept="image/*">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeAddModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Product</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal" *ngIf="showEditModal">
  <div class="modal-content">
    <h2>Edit Product</h2>
    <form (ngSubmit)="onUpdateProduct()">
      <div class="form-group">
        <label>Product Name</label>
        <input type="text" class="form-control" [(ngModel)]="productForm.name" name="name" required>
      </div>
      <div class="form-group">
        <label>Price</label>
        <input type="number" step="0.01" class="form-control" [(ngModel)]="productForm.price" name="price" required>
      </div>
      <div class="form-group">
        <label>Category</label>
        <select class="form-control" [(ngModel)]="productForm.category_id" name="category_id" required>
          <option value="">Select Category</option>
          <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Image (leave empty to keep current)</label>
        <input type="file" class="form-control" (change)="onFileSelected($event)" accept="image/*">
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Update Product</button>
      </div>
    </form>
  </div>
</div>

<!-- Bulk Upload Modal -->
<div class="modal" *ngIf="showBulkModal">
  <div class="modal-content">
    <h2>Bulk Upload Products</h2>
    <div class="alert alert-info">
      <p><strong>Instructions:</strong></p>
      <ul>
        <li>Upload a CSV or XLSX file</li>
        <li>Required columns: name, price, category_id</li>
        <li>Optional column: image</li>
        <li>Make sure category_id exists in the database</li>
      </ul>
    </div>
    <div class="form-group">
      <label>Select File (CSV or XLSX)</label>
      <input type="file" class="form-control" (change)="onBulkFileSelected($event)" accept=".csv,.xlsx">
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" (click)="closeBulkModal()">Cancel</button>
      <button type="button" class="btn btn-success" (click)="onBulkUpload()" [disabled]="!bulkFile || loading">
        {{ loading ? 'Uploading...' : 'Upload' }}
      </button>
    </div>
  </div>
</div>
